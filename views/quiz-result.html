{{!< ./default_layout}}
<h1> Result for {{quizResult.quiz.title}} </h1>

{{#if messages.error}}
	<p>{{messages.error}}</p>
{{/if}}

<p>
	Score: {{quizResult.percentCorrect}}%
</p>


<h4>
	Answers:
</h4>

<table class="table">
	<tr>
		<th>Number</th>
		<th>Image</th>
		<th>Correct</th>
		<th>Your answer</th>
		<th>Correct answer</th>
		<th>Explanation</th>
		<th>Time</th>
	</tr>
	{{#each quizResult.quizQuestions}}
		<tr>
			<td>{{math @index "+" 1}}</td>
			<td>
				<img height="200" width="200" class="lazy-load" data-src="{{this.questionId.studyId}}" data-loc="{{this.abnormalityLoc.coords}}">
			</td>
			<td>
				{{#if this.correct}}
					Y
				{{else}}
					N
				{{/if}}
			</td>
			<td>{{userAnswer this "option"}}</td>
			<td>{{correctAnswer this "option"}}</td>
			<td>{{correctAnswer this "explanation"}}</td>
			<td>{{questionTime this.questionTime}}</td>
		</tr>
	{{/each}}
</table>

<script type="text/javascript">
$(document).ready(function(){

	var lazyImages = $('.lazy-load')

	lazyImages.each(function(i, img){

		var studyId = $(img).attr('data-src')

		$.ajax({url: '/api/getImageObject/' + studyId, dataType: 'json', context: img})
				.done(function(res) {

					console.log('loaded image: ', res)

					$(this)
						.one('load', function(e){

							var el = e.target

							if ($(el).attr('data-loc') === ''){ return false }

							// put crosshairs on it
							var w = el.naturalWidth,
								//h = el.naturalHeight,
								ratio = w / $(el).width(),
								offset = $(el).offset(),
								marker = $('<span></span>').addClass('glyphicon glyphicon-screenshot icon-red').css('position', 'absolute'),
								loc = $(el).attr('data-loc').split(',').map(function(i){return parseInt(i)}),
								mTop = offset.top + (loc[1] / ratio),
								mLeft = offset.left + (loc[0] / ratio)

							marker.css({'top': mTop, 'left': mLeft})
							$('body').append(marker)

						})
						.attr('src', res.imageStacks[0].imagePaths[0])
						.each(function() {
							//Cache fix for browsers that don't trigger .load()
							if(this.complete){ $(this).trigger('load') }
						})
					
				})
				.fail(function(err) {

					console.error(err)
				})
	})
})
</script>